<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>Dashpilot</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
  <link rel="stylesheet" href="style.css">
</head>

<body spellCheck="false">
  <main class="container mt-5">
    <div x-data="loadData()" x-init="loadData().get">

      <template x-if="data">

        <template x-for="key in Object.keys(data)">
          <div>
            <h1 x-text="key"></h1>
            <template x-for="item, mykey in data[key]">
              <div class="post">

                <b x-text="item.title" @click="show = item.id"></b>
                <template x-if="show == item.id">
                  <div class="form">

                    <input type="text" x-model="item.title" class="form-control">

                    <alpine-editor x-model="item.body" data-h1-classes="text-xl">
                      <div data-type="menu" class="rte-toolbar">
                        <div class="btn-group">
                          <button type="button" data-command="strong" data-active-class="bg-blue-400" class="btn btn-outline-secondary">
                            Bold
                          </button>
                          <button type="button" data-command="em" data-active-class="bg-blue-400" class="btn btn-outline-secondary">
                            Italic
                          </button>

                        </div>
                      </div>

                      <div class="border mt-2">
                        <div data-type="editor" class="p-2" x-on:input="item.body = document.querySelectorAll('.ProseMirror')[0].innerHTML">
                        </div>
                      </div>
                    </alpine-editor>

                    <template x-if="item.hasOwnProperty('data')">
                      <template x-for="mykey in Object.keys(item.data)">
                        <div>
                          <template x-if="mykey != 'title'">
                            <div>
                              <div class="label" x-text="mykey"></div>
                              <input type="text" x-model="item.data[mykey]" class="form-control">
                            </div>
                          </template>
                        </div>
                      </template>
                    </template>

                    <button class="btn btn-outline-success mt-3" @click="save();">Save</button>

                  </div>
                </template>
              </div>
            </template>
          </div>
        </template>

      </template>

    </div>
    <script>
      function loadData() {
        return {
          // other default properties
          isLoading: false,
          data: null,
          show: null,
          get() {
            this.isLoading = true;
            var opts = {
              path: "posts/blog/hello.md",
            }
            fetch('/api/github/get-data', {
                headers: {
                  'Authorization': window.token,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(opts),
                method: 'post',
              })
              .then(response => response.json())
              .then(res => {
                console.log('Success:', res)
              })
              .catch(error => {
                console.error('Error:', error)
              })
          },
          save() {
            console.log(document.querySelector('[x-data]').__x.getUnobservedData().data);
            var data = document.querySelector('[x-data]').__x.getUnobservedData().data;
            var opts = {
              path: "public/data.json",
              type: "json",
              content: data
            }
            fetch('/api/github/set-data', {
                headers: {
                  'Authorization': window.token,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(opts),
                method: 'post',
              })
              .then(response => response.json())
              .then(res => {
                console.log('Success:', res)
              })
              .catch(error => {
                console.error('Error:', error)
              })


          }
        }
      }
    </script>

  </main>

  <script src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.8.1/dist/alpine.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/gh/maxeckel/alpine-editor@0.3.1/dist/alpine-editor.min.js"></script>
  <script type="text/javascript" src="https://sdk.userbase.com/2/userbase.js"></script>
  <script>
    config = {};
    config.appId = 'ac1c771e-cae2-4fae-b559-312cd95b5d76';
    userbase
      .init({
        appId: config.appId,
      })
      .then(function(session) {


        if (typeof session.user !== 'undefined') {
          console.log('logged in')
          sessionStorage.setItem('username', session.user.username);
          window.token = session.user.authToken;
        } else {

          sessionStorage.removeItem('username');
        }

      });
  </script>
</body>

</html>
